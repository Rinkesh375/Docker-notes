# ------------------------------------------------------------
# üê≥ Docker Compose Configuration for E-Commerce Project
# ------------------------------------------------------------
# This file defines three services:
# 1Ô∏è‚É£ Backend - Custom Node/Express/Nest App
# 2Ô∏è‚É£ PostgreSQL - Database Service
# 3Ô∏è‚É£ Redis - Caching Service
# ------------------------------------------------------------

name: e-commerce # Optional: sets a project name for Docker Compose

services:
  # ----------------------------------------------------------
  # ‚öôÔ∏è Backend Service
  # ----------------------------------------------------------
  backend:
    build:
      context: . # Build from current directory
      dockerfile: Dockerfile # Use the Dockerfile present in this directory
    container_name: backend # Name for the backend container
    ports:
      - "8000:8000" # Map local port 8000 ‚Üí container port 8000
    depends_on:
      - db # Wait for PostgreSQL to start
      - redis # Wait for Redis to start

  # ------------------------------------------------------------
  # 1Ô∏è‚É£ Build the backend image using the Dockerfile Equivalent CLI Commands (For Reference)
  # ------------------------------------------------------------
  # docker build -t backend .    
  # üß† Meaning:
  # - "docker build" ‚Üí Builds a Docker image
  # - "-t backend"   ‚Üí Tags the image with the name "backend"
  # - "."            ‚Üí Uses the current directory as the build context (where Dockerfile is located)
  # ------------------------------------------------------------


  # ------------------------------------------------------------
  # 2Ô∏è‚É£ Run the backend container using the built image
  # ------------------------------------------------------------
  # docker run -d --name backend \
  #   -p 8000:8000 \
  #   --link postgres \
  #   --link redis \
  #   backend
  # üß† Meaning:
  # - "-d"              ‚Üí Run in detached (background) mode
  # - "--name backend"  ‚Üí Name the running container "backend"
  # - "-p 8000:8000"    ‚Üí Map local port 8000 ‚Üí container port 8000
  # - "--link postgres" ‚Üí Connect to the PostgreSQL container (defined as 'db' in Compose)
  # - "--link redis"    ‚Üí Connect to the Redis container
  # - "backend"         ‚Üí The image name to use for running this container
  # ------------------------------------------------------------



  # ----------------------------------------------------------
  # üß© PostgreSQL Database Service
  # ----------------------------------------------------------
  db:
    image: postgres:16 # Use the official Postgres 16 image
    container_name: postgres # Assign a custom name to the container
    environment:
      POSTGRES_USER: postgres # Database username
      POSTGRES_PASSWORD: postgres # Database password
      POSTGRES_DB: postgres # Default database name
    ports:
      - "5431:5432" # Maps local port 5431 ‚Üí container port 5432 (for external access). 
    # If the backend runs in another container within the same network,
    # this port mapping is not required ‚Äî they can communicate internally using the service name (db:5432).
    # This is only needed if you want to connect to postgres from your host machine 
    volumes:
      - postgres_data:/var/lib/postgresql/data # Store PostgreSQL data persistently

  # ----------------------------------------------------------
  # ‚ö° Redis Caching Service
  # ----------------------------------------------------------
  redis:
    image: redis:7-alpine # Lightweight Redis image (version 7)
    container_name: redis # Name of the Redis container
    depends_on:
      - db # Ensures Redis starts after 'db' service
    ports:
      - "6379:6379" # Maps local port 6379 ‚Üí container port 6379 (for external access).
    # This is only needed if you want to connect to Redis from your host machine 
    # (e.g., using RedisInsight or redis-cli locally).
    # If the backend connects to Redis internally through the Docker network (using host: redis, port: 6379),
    # this port mapping is not required.

    volumes:
      - redis_data:/data # Persistent volume for Redis cache data

# ------------------------------------------------------------
# üíæ Docker Volumes (Persistent Data Storage)
# ------------------------------------------------------------
volumes:
  postgres_data: # Volume for PostgreSQL data
  redis_data:
    # Volume for Redis cache data

    # ------------------------------------------------------------
    # üí° Equivalent CLI Commands (For Reference)
    # ------------------------------------------------------------
    # üß± Create Volumes Manually:
    # docker volume create postgres_data
    # docker volume create redis_data
    #
    # üîç View All Volumes:
    # docker volume ls | grep post
    #
    # üß∞ Run PostgreSQL Manually:
    # docker run -d --name postgres \
    #   -e POSTGRES_USER=postgres \
    #   -e POSTGRES_PASSWORD=postgres \
    #   -e POSTGRES_DB=postgres \
    #   -v postgres_data:/var/lib/postgresql/data \
    #   -p 5431:5432 postgres:16
    #
    # ‚öôÔ∏è Run Redis Manually:
    # docker run -d --name redis \
    #   -p 6379:6379 \
    #   -v redis_data:/data redis:7-alpine
    #
    # ‚ôªÔ∏è Rebuild Services:
    # docker compose up --build
    #
    # üßπ Stop & Remove Containers:
    # docker compose down
    # ------------------------------------------------------------
