# ------------------------------------------------------------
# ğŸ§± BASE STAGE
# ------------------------------------------------------------
# FROM node:alpine3.21 as base
# â†’ Starts with a clean, lightweight Node.js image based on Alpine Linux.
# â†’ Think of this as starting a new, empty computer with Node already installed.
# â†’ This base setup will be reused for both building and running stages.
FROM node:alpine3.21 as base


# ------------------------------------------------------------
# ğŸ—ï¸ BUILDER STAGE
# ------------------------------------------------------------
# FROM base as builder
# â†’ Starts a new temporary â€œbuilder computerâ€ from the same base.
# â†’ Used only for compiling and preparing the final build output.
FROM base as builder

# Set working directory inside container
WORKDIR /home/build

# Copy dependency files (package.json & package-lock.json)
COPY package*.json ./

# Copy TypeScript configuration
COPY tsconfig.json ./

# Install all dependencies (including dev tools like TypeScript)
RUN npm install

# Copy source code into container
COPY src ./src

# Build the TypeScript project (TS â†’ JS)
RUN npm run build


# ------------------------------------------------------------
# ğŸš€ RUNNER STAGE
# ------------------------------------------------------------
# FROM base as runner
# â†’ Starts a new, clean â€œruntime computerâ€ from the same base image.
# â†’ This stage only includes whatâ€™s needed to run the app â€” no dev tools.
FROM base as runner

# Set working directory for the running application
WORKDIR /home/app

# Copy built JavaScript files from builderâ€™s dist folder
COPY --from=builder /home/build/dist ./dist

# Copy package.json files for installing production dependencies
COPY --from=builder /home/build/package*.json ./

# Install only production dependencies (no devDependencies)
RUN npm install --omit=dev


# ------------------------------------------------------------
# ğŸ‘¥ CREATE NON-ROOT USER FOR SAFETY
# ------------------------------------------------------------

# Create a new system group named 'nodejs' with group ID 1001
RUN addgroup --system --gid 1001 nodejs

# Create a new system user named 'nodejs' with user ID 1001
# and automatically add it to the 'nodejs' group
RUN adduser --system --uid 1001 nodejs

# Switch to the newly created 'nodejs' user
# â†’ This ensures the app runs as a normal (non-admin) user
# â†’ Prevents the app from having unnecessary root privileges
USER nodejs



# ------------------------------------------------------------
# ğŸŒ EXPOSE PORT
# ------------------------------------------------------------

# Tell Docker that the container will listen on port 8000
# â†’ This does NOT actually open the port â€” it just documents it
# â†’ Other containers or users can map to this port when running the container
EXPOSE 3000


# ------------------------------------------------------------
# âš™ï¸ SET ENVIRONMENT VARIABLE
# ------------------------------------------------------------

# Set an environment variable named PORT with the value 8000
# â†’ The app inside the container can access it using process.env.PORT in Node.js
ENV PORT=3000


# Define default command to run the app
CMD [ "npm", "start" ]



